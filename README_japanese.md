# ⚽ FreezeFrame xG: 文脈を考慮したゴール期待値モデル

`Python` `Streamlit` `XGBoost` `StatsBomb`

**「位置データを超えて」** — 単なるシュート位置（座標）のデータを超え、守備のプレッシャーや視覚的なゴール幅（フリーズフレーム）などの「文脈」を取り入れた高精度なゴール期待値（xG）モデルです。Shapelyを用いた幾何学的特徴量生成や、SHAPを用いた予測因子の分析（XAI）を実装しています。

🔗 **デモサイト**
👉 [Webアプリを起動] https://soccer-xg-analysis-f6pgtnnzixwnbfbavbfrrk.streamlit.app/ (Streamlit Cloudにて公開中 / データ：2022年 FIFAワールドカップ)

---

### 1. プロジェクト概要

#### 🎯 課題

単にシュートの距離と角度だけで計算するxGモデルではなく、「試合の文脈（コンテキスト）」を組み込んだ高精度なモデルの構築を目指しました。また、このモデルを用いて試合の流れや個々の選手の決定力を定量的に分析することを目的としています。

**考慮した主なコンテキスト因子:**

* **守備プレッシャー:** シューターはプレッシャーを受けていたか？
* **シュートブロック:** ゴールラインとの間に何人の守備選手がいたか？
* **GKのポジション:** GKは正しい位置にいたか、あるいは外していたか？
* **視界（Vision）:** 障害物を考慮した際、シューターからゴールはどの程度広く見えていたか？

#### 🛠 手法と革新性

* **アンサンブル学習:** 解釈性に優れた「ロジスティック回帰」と、非線形な関係を捉える「XGBoost」を組み合わせたアンサンブル手法を採用。
* **幾何学的特徴量エンジニアリング:** `Shapely`ライブラリを使用し、「シュートコーン（射線）」内の相手選手数を算出。
* **XAI（説明可能AI）:** `SHAP`値を実装し、期待値の背景にある「要因」を可視化。
* **Webアプリケーション:** `Streamlit`を用いて、ワールドカップのデータから試合の勢いや個人パフォーマンスを分析できるダッシュボードを開発。

#### 🏆 最終結果

精度スコアだけでなく、予測確率が現実の発生頻度と一致しているかを確認する「キャリブレーションカーブ」を重視して検証しました。

| モデル | Brier Score (↓) | Log Loss (↓) | 備考 |
| --- | --- | --- | --- |
| ロジスティック回帰 | 0.07353 | 0.26117 | ベースライン |
| XGBoost (チューニング済) | 0.07370 | 0.26160 | 非線形特徴量の抽出 |
| **アンサンブル (最終)** | **0.07330** | **0.25990** | **ベストモデル** |

---

### 2. データソース

本プロジェクトでは **StatsBomb Open Data** を使用しています。

* **学習用:** イングランド・プレミアリーグ (2015/2016シーズン)
* **アプリ・検証用:** 2022 FIFAワールドカップ
* *注意: W杯データとプレミアリーグデータではカラム構造が若干異なるため、スキーマを合わせる前処理を行っています。*

---

### 3. 分析フロー

StatsBombから提供される生のイベントデータには座標は含まれますが、「ゴールへの距離」や「角度」といったモデルに即した特徴量は含まれていません。そのため、ベースラインモデルから始め、仮説に基づき段階的に特徴量を増やして精度を向上させました。

**🔄 開発ステップ:**

1. データ取得と前処理
2. `BASE_FEATURES` 作成 → ロジスティック回帰で学習・検証
3. `CONTEXT_FEATURES` 追加 → 学習・検証
4. `ADVANCED_GEOMETRY_FEATURES` 追加 → 学習・検証
5. `ASSIST_FEATURES` 追加 → 学習・検証
6. `SHOT_BLOCK_FEATURES` 追加 → 学習・検証（ここまでの特徴量の有効性を確認）
7. 全特徴量を用いてXGBoostを学習（交差検証）
8. ハイパーパラメータのチューニング（LR & XGBoost）
9. アンサンブルモデルの作成（最終検証）

---

### 4. 特徴量エンジニアリング（技術詳細）

精度向上の最大の要因は、座標データから直接「距離・角度・ポリゴン」を計算した複雑な特徴量の生成にあります。

#### 📐 特徴量ロジック

* **shot_distance:** 三平方の定理を用い、ゴール中心までのユークリッド距離を算出。
* **shot_angle:** シューターと両ゴールポストを結ぶベクトルの内積から視野角を算出。
* **effective_goal_width:** 物理的なゴール幅は一定ですが、角度がつくと狭く見えます。三角関数を用いて、プレイヤーから見た「見かけ上のゴール幅」を算出。
* **total_players_in_shot_cone:** シューターと両ゴールポストを結ぶ三角形（シュートコーン）をポリゴンとして作成し、その中に存在する選手数をカウント。
* *この「シュートブロック因子」がスコア改善に最も大きく寄与しました。*



#### 📝 特徴量グループ

1. **📍 BASE_FEATURES:** 物理的な座標のみに基づく基本変数。
2. **🧠 CONTEXT_FEATURES:** 位置だけでは判定できない文脈情報（プレッシャーの有無、使用部位、プレーパターンなど）。
3. **📐 GEOMETRY_FEATURES (Freeze Frame):** `Shapely`を用いて計算された高度な幾何学特徴量（GKとの距離、シュートコーン内の人数、相互作用項など）。
4. **⚽ ASSIST_FEATURES:** シュート直前のパスに関する情報（パスの長さ、クロス/スルーパスの判定など）。

---

### 5. 実験と結果

#### 検証スコアの推移

特徴量を追加するたびに、Log Loss（不確実性）とBrier Score（誤差）が着実に減少しました。特に「文脈情報」と「シュートブロック情報」の追加時に大幅な改善が見られました。

| モデルフェーズ | Brier Score (↓) | Log Loss (↓) |
| --- | --- | --- |
| 基本特徴量のみ | 0.07775 | 0.27601 |
| + 文脈特徴量 | 0.07440 | 0.26315 |
| + 幾何学特徴量 | 0.07431 | 0.26250 |
| + アシスト特徴量 | 0.07394 | 0.26060 |
| + シュートブロック特徴量 | **0.07297** | **0.25753** |

---

### 6. モデリング戦略と評価指標

* **ロジスティック回帰:** 係数の影響が分かりやすく、解釈性のベースラインとして採用。
* **XGBoost:** 「距離は近いが守備が多い」といった変数間の複雑な非線形関係を捉えるために採用。
* **GroupKFold交差検証:** サッカーでは同じ試合内のイベントは相関が強いため、通常のランダム分割ではリーク（漏洩）が発生します。試合単位(`match_id`)でグループ化して分割することで、未知の試合に対する汎用性を担保しました。

---

### 7. Webアプリケーションの機能

* **xG Flow Chart:** 両チームのxGの推移を可視化。シュート数だけでは見えない「どちらが主導権を握っていたか」を明らかにします。
* **Player Performance:** xG（チャンスの大きさ）と実際のゴール数を比較し、選手の決定力を分析。
* **Freeze Frame & SHAP 可視化:** シュート瞬間の全選手の配置をプロット。さらにSHAP値を用いて、「なぜそのxG値になったのか」を「GKが近かった」「相手の密度が高かった」などの要因ごとに数値化して表示します。

---

### 8. 結論

* 高度な文脈情報と幾何学的情報（フリーズフレーム）を組み込むことで、モデルの精度は明確に向上します。
* 線形モデル（LR）と非線形モデル（XGB）をアンサンブルすることで、単一モデルでは到達できない高精度かつ安定した予測が可能になります。

---

### 9. 使用技術（Tech Stack）

* **Language:** Python 3.12
* **ML:** XGBoost, Scikit-learn, SHAP
* **Geometry:** Shapely
* **Visualization:** Matplotlib, Seaborn
* **Web App:** Streamlit
* **Data Source:** StatsBomb Open Data

---

**License:** MIT License
